#!/usr/bin/env bash
# tdb - TempleDB + Claude Code launcher
# Usage: tdb <command> [project] [args...]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${YELLOW}→ $1${NC}"
}

# Show usage
usage() {
    cat << EOF
tdb - TempleDB + Claude Code launcher

Usage:
  tdb claude <project>              Launch Claude Code with project context
  tdb import <repo-url> [name]      Import project into TempleDB
  tdb list                          List all projects
  tdb sync <project>                Sync project with filesystem

Examples:
  tdb claude woofs_project          # Launch Claude with woofs_project context
  tdb import https://github.com/user/repo myproject
  tdb list

Environment:
  TEMPLEDB_USER                     Set agent identifier (default: claude-\$USER)

EOF
    exit 0
}

# Check if project exists in TempleDB
project_exists() {
    local project="$1"
    ./templedb project show "$project" &>/dev/null
}

# Import project if it doesn't exist
ensure_project() {
    local project="$1"

    if ! project_exists "$project"; then
        error "Project '$project' not found in TempleDB. Import it first with: tdb import <repo-url> $project"
    fi
}

# Launch Claude Code with project context
cmd_claude() {
    local project="$1"

    if [ -z "$project" ]; then
        error "Usage: tdb claude <project>"
    fi

    ensure_project "$project"

    # Set agent identifier if not already set
    if [ -z "$TEMPLEDB_USER" ]; then
        export TEMPLEDB_USER="claude-$USER"
        info "Using agent identifier: $TEMPLEDB_USER"
    fi

    # Get project info
    info "Loading project: $project"

    # Check if we're already in a Claude Code session
    if [ -n "$CLAUDE_CODE" ]; then
        info "Already in Claude Code session"
        info "Generating context for $project..."
        echo
        echo "# TempleDB Context for $project"
        echo
        echo "You can now use these MCP tools:"
        echo "  - templedb_context_generate - Generate full project context"
        echo "  - templedb_search_content - Search code"
        echo "  - templedb_search_files - Find files"
        echo "  - templedb_query - Run SQL queries"
        echo
        echo "Try: 'Generate context for $project'"
    else
        # Launch Claude Code with instructions
        info "Launching Claude Code..."
        echo
        echo "To Claude: Please generate context for project '$project' using templedb_context_generate"
        echo

        # Start Claude Code in the project directory if it exists
        project_dir=$(./templedb project show "$project" 2>/dev/null | grep "Git Remote" | awk '{print $NF}' | sed 's|.*/||' | sed 's|\.git||')

        if [ -n "$project_dir" ] && [ -d "../$project_dir" ]; then
            cd "../$project_dir"
            info "Changed to project directory: $project_dir"
        fi

        # Check if claude command exists
        if command -v claude &> /dev/null; then
            claude
        else
            error "claude command not found. Install Claude Code CLI first."
        fi
    fi
}

# Import project
cmd_import() {
    local repo_url="$1"
    local name="$2"

    if [ -z "$repo_url" ]; then
        error "Usage: tdb import <repo-url> [name]"
    fi

    info "Importing $repo_url..."

    if [ -n "$name" ]; then
        ./templedb project import "$repo_url" --name "$name"
    else
        ./templedb project import "$repo_url"
    fi

    success "Project imported"
}

# List projects
cmd_list() {
    ./templedb project list
}

# Sync project
cmd_sync() {
    local project="$1"

    if [ -z "$project" ]; then
        error "Usage: tdb sync <project>"
    fi

    ensure_project "$project"

    info "Syncing $project..."
    ./templedb project sync "$project"
    success "Project synced"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        usage
    fi

    local command="$1"
    shift

    case "$command" in
        claude)
            cmd_claude "$@"
            ;;
        import)
            cmd_import "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        sync)
            cmd_sync "$@"
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            error "Unknown command: $command. Use 'tdb --help' for usage."
            ;;
    esac
}

main "$@"
